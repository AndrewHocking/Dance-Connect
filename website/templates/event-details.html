{% extends "base.html" %}
{% from "macros.html" import accessibility_icon %}

{% block title %}{{ event.title }}{% endblock %}
{% block content %}
{% set icons_to_show_in_legend = {"relaxed_performance": False, "photosensitivity_friendly": False, "photosensitivity_unfriendly": False,
"hearing_accessible": False, "visually_accessible": False} %}

<div class="container">
    <h1>{{ event.title }}</h1>
    <div class="col">
        <div class="row d-flex flex-wrap gx-1 pb-4">
            {% for tag in event.tags %}
            <form class="col-auto" action="{{ url_for('events.events_list') }}" method="POST">
                <button name="tags" value="{{ tag.name }}"
                    class="me-1 mb-1 px-2 py-0 text-dark bg-opacity-25 rounded text-nowrap tag btn btn-sm">{{ tag.name }}</button>
            </form>
            {% endfor %}
        </div>
        <div class="clearfix">
            <div class="row gx-0 gy-2 d-flex flex-wrap d-lg-block container mx-0 px-0">
                <div id="image" class="col-lg-5 float-start order-1 mb-2">
                    <div class="rounded image-container overflow-hidden position-relative">
                        <img src="{{url_for('static', filename='images/placeholder.jpg')}}"
                            class="img-fluid rounded position-absolute top-50 start-50 translate-middle" alt="{{event.title}}"
                            style="height:300px; width:100%; object-fit: cover;" />
                    </div>
                </div>
                <div id="right-column" class="col-lg-7 float-end order-3 order-lg-2 ps-lg-4 mb-3">
                    <div class="row gy-4">
                        <div id="description" class="col-12">
                            <h3>Description</h3>
                            <p>{{event.description}}</p>
                            {% if event.accessibility_notes %}
                            <h6 class="m-0">Accessibility Notes</h6>
                            <p>{{event.accessibility_notes}}</p>
                            {% endif %}
                            <div class="row align-items-center">
                                {% if event.url %}
                                <div class="col-auto">
                                    <a class="btn btn-primary" href="{{event.url}}">
                                        <i class="bi bi-link-45deg"></i>
                                        Learn More
                                    </a>
                                </div>
                                {% endif %}
                                {% if event.min_ticket_price != None or event.max_ticket_price != None %}
                                <div class="col-auto rotate-n45 m-0 p-0">
                                    <div class="sr-only">Ticket Prices</div>
                                    <i class="bi bi-ticket-perforated-fill"></i>
                                </div>
                                <div class="col-auto px-1">
                                    {% if event.min_ticket_price != None %}
                                    {% if event.max_ticket_price == None %}
                                    From {{ ("${:,.2f}".format(event.min_ticket_price)).rstrip('0').rstrip('.') }}
                                    {% else %}
                                    {{ ("${:,.2f}".format(event.min_ticket_price)).rstrip('0').rstrip('.') }} â€“ {{
                                                                                                ("${:,.2f}".format(event.max_ticket_price)).rstrip('0').rstrip('.')}}
                                    {% endif %}
                                    {% elif event.max_ticket_price != None %}
                                    Up to {{ ("${:,.2f}".format(event.max_ticket_price)).rstrip('0').rstrip('.') }}
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div id="location" class="col-12">
                            <h3>Location</h3>
                            <div class="row align-middle pb-2">
                                <div class="col-lg-auto col-12 pe-0">
                                    <div class="dropdown py-lg-2 pb-2">
                                        <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            <i class="bi bi-geo-alt-fill"></i>
                                            <span class="d-lg-none">Directions</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item"
                                                    href="https://www.google.com/maps?saddr=My+Location&daddr={{(event.venue_address)|urlencode}}"
                                                    target="_blank" rel="noopener noreferrer">
                                                    Google Maps
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="http://maps.apple.com/?q={{(event.venue_address)|urlencode}}"
                                                    target="_blank" rel="noopener noreferrer">
                                                    Apple Maps
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item"
                                                    href="https://www.waze.com/ul?q={{(event.venue_address)|urlencode}}&navigate=yes" target="_blank"
                                                    rel="noopener noreferrer">
                                                    Waze
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="fw-semibold">{{event.venue_name}}</div>
                                    <div>{{event.venue_address}}</div>
                                </div>
                            </div>
                            <ul class="list-group">
                                <li class="list-group-item d-inline-flex align-items-center">
                                    <ul class="list-inline row align-items-center ps-2">
                                        {{ accessibility_icon("mobility aid", not event.venue_is_mobility_aid_accessible) }}
                                        <li class="col list-inline-item">
                                            <div>
                                                This venue is {{'not' if not event.venue_is_mobility_aid_accessible }} fully accessible for
                                                individuals
                                                who use mobility aids, such as wheelchairs.
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                <li class="list-group-item bg-secondary-subtle" style="height: 300px;">
                                </li>
                            </ul>
                        </div>
                        <div id="times" class="col-12">
                            <h3>Times</h3>
                            <div class="border rounded-3 overflow-hidden p-0 m-0">
                                <table class="table table-striped table-borderless p-0 m-0" style="--bs-table-striped-bg: var(--bs-tertiary-bg);">
                                    {% for date in occurrences %}
                                    <tr>
                                        <td class="align-middle {{ 'border-top' if not loop.first }}">
                                            {{date}}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-0 m-0 align-middle border-top">
                                            <table class="table table-borderless m-0">
                                                {% for occurrence in occurrences[date] %}
                                                <tr class="align-middle {{ 'border-top' if not loop.first }}">
                                                    <td>
                                                        {{ occurrence.start_time.strftime("%I:%M %p") + ((" - " + occurrence.end_time.strftime("%I:%M %p")) if occurrence.end_time else "") }}
                                                    </td>
                                                    <td class="text-end">
                                                        <ul class="list-inline m-0 d-inline-flex align-middle">
                                                            {% if occurrence.is_relaxed_performance %}
                                                            {% set _ = icons_to_show_in_legend.update({"relaxed_performance": True}) %}
                                                            {{ accessibility_icon("relaxed performance", false, "ms-1") }}
                                                            {% endif %}
                                                            {% if occurrence.is_photosensitivity_friendly %}
                                                            {% set _ = icons_to_show_in_legend.update({"photosensitivity_friendly": True}) %}
                                                            {% else %}
                                                            {% set _ = icons_to_show_in_legend.update({"photosensitivity_unfriendly": True}) %}
                                                            {% endif %}
                                                            {{ accessibility_icon("photosensitivity", not occurrence.is_photosensitivity_friendly, "ms-1") }}
                                                            {% if occurrence.is_hearing_accessible %}
                                                            {% set _ = icons_to_show_in_legend.update({"hearing_accessible": True}) %}
                                                            {{ accessibility_icon("hearing", false, "ms-1") }}
                                                            {% endif %}
                                                            {% if occurrence.is_visually_accessible %}
                                                            {% set _ = icons_to_show_in_legend.update({"visually_accessible": True}) %}
                                                            {{ accessibility_icon("vision", false, "ms-1") }}
                                                            {% endif %}
                                                        </ul>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </table>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                        <div id="accessibility" class="col-12">
                            <h5>Accessibility Icon Legend</h5>
                            <ul class="list-group">
                                {% if icons_to_show_in_legend["relaxed_performance"] %}
                                <li class="list-group-item d-inline-flex align-items-center">
                                    <ul class="list-inline row align-items-center ps-2">
                                        {{ accessibility_icon("relaxed performance", false, "ms-1") }}
                                        <li class="col list-inline-item">
                                            <div>
                                                This is a relaxed performance.
                                                <a href="https://www.sensoryfriendly.net/sensory-relaxed-performances/#What-makes-a-performance-relaxed"
                                                    title="What is a relaxed performance?" target="_blank" rel="noopener noreferrer">
                                                    <i class="bi bi-question-circle"></i>
                                                </a>
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                {% endif %}
                                {% if icons_to_show_in_legend["photosensitivity_unfriendly"] %}
                                <li class="list-group-item d-inline-flex align-items-center">
                                    <ul class="list-inline row align-items-center ps-2">
                                        {{ accessibility_icon("photosensitivity", true, "ms-1") }}
                                        <li class="col list-inline-item">
                                            <div>
                                                Some lighting effects used during this event may pose risks for individuals who experience
                                                photosensitivity.
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                {% endif %}
                                {% if icons_to_show_in_legend["photosensitivity_friendly"] %}
                                <li class="list-group-item d-inline-flex align-items-center">
                                    <ul class="list-inline row align-items-center ps-2">
                                        {{ accessibility_icon("photosensitivity", false, "ms-1") }}
                                        <li class="col list-inline-item">
                                            <div>
                                                Any lighting effects used during this event should be safe for individuals who experience
                                                photosensitivity.
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                {% endif %}
                                {% if icons_to_show_in_legend["hearing_accessible"] %}
                                <li class="list-group-item d-inline-flex align-items-center">
                                    <ul class="list-inline row align-items-center ps-2">
                                        {{ accessibility_icon("hearing", false, "ms-1") }}
                                        <li class="col list-inline-item">
                                            <div>
                                                This event is, or has been modified to be, accessible for individuals who are deaf or hard of hearing.
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                {% endif %}
                                {% if icons_to_show_in_legend["visually_accessible"] %}
                                <li class="list-group-item d-inline-flex align-items-center">
                                    <ul class="list-inline row align-items-center ps-2">
                                        {{ accessibility_icon("vision", false, "ms-1") }}
                                        <li class="col list-inline-item">
                                            <div>
                                                This event is, or has been modified to be, accessible for individuals who are blind or have low
                                                vision.
                                            </div>
                                        </li>
                                    </ul>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="contributors" class="col-lg-5 float-start order-last my-3">
                    <div class="row bg-body-tertiary rounded mx-0 justify-content-center py-3">
                        <div class="row">
                            <h3>Contributors</h3>
                        </div>
                        {% if contributors|length > 0 %}
                        <div class="row justify-content-center">
                            {% from "macros.html" import event_contributors %}
                            {{ event_contributors(contributors=contributors, limit=8) }}
                            {% if contributors|length > 8 %}
                            <div id="btn-view-all" class="col-auto align-items-center justify-content-center my-2 text-decoration-none text-body"
                                data-bs-toggle="modal" data-bs-target="#view-all-modal" style="width: 140px;">
                                <div class="rounded-circle mx-auto btn-primary" style="height: 100px; width: 100px; object-fit: cover;">
                                    <i class="bi bi-people-fill text-white d-flex align-items-center justify-content-center fs-1"
                                        style="height: 100%;"></i>
                                </div>
                                <div class="text-center text-truncate w-100 fw-medium pt-2">View all</div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="row justify-content-center">
                            <div class="col-auto">
                                <div class="p-4">No contributors yet.</div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="row justify-content-center">
                            {% if user.is_authenticated %}
                            <div id="join-request-buttons" class="col-auto">
                                {% if event in current_user.events_contributed %}
                                <button id="btn-leave-event" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#leave-modal">
                                    <i class="bi bi-person-fill-dash"></i>
                                    Remove self as a contributor
                                </button>
                                {% elif event_request_notification == None %}
                                <button id="btn-join-event" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#join-modal">
                                    <i class="bi bi-person-fill-add"></i>
                                    Request to be a contributor
                                </button>
                                {% else %}
                                <form method="post" action="/events/{{event.id}}/cancel-join-request">
                                    <button id="btn-cancel-join-request" class="btn btn-primary mt-2">
                                        <i class="bi bi-person-fill-x"></i>
                                        Cancel request to be a contributor
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="view-all-modal" tabindex="-1" aria-labelledby="view-all-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="view-all-modal-label">Contributors</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="view-all-modal-content" class="row justify-content-center">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="join-modal" tabindex="-1" aria-labelledby="join-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" method="post" action="/events/{{event.id}}/join">
            <div class="modal-header">
                <h5 class="modal-title" id="join-modal-label">Request to join event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="role" class="form-label">What role will you be playing in this event?</label>
                    <input type="text" class="form-control" id="role" name="role" aria-describedby="role-description" required>
                    <div class="form-text" id="role-description" name="role">
                        Your role in the production, the name of your character, etc.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="btn-confirm-join-event" type="submit" class="btn btn-primary">Request to join</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="leave-modal" tabindex="-1" aria-labelledby="leave-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" method="post" action="/events/{{event.id}}/leave">
            <div class="modal-header">
                <h5 class="modal-title" id="leave-modal-label">Leave event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to leave this event?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="btn-confirm-leave-event" type="submit" class="btn btn-primary">Leave event</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.getElementById("btn-view-all").addEventListener("click", function () {
        if (!document.getElementById("view-all-modal-content").innerHTML.includes("spinner-border")) {
            return;
        }
        fetch("/events/{{event.id}}/contributors", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
        }).then(function (response) {
            if (response.ok) {
                response.text().then(function (content) {
                    document.getElementById("view-all-modal-content").innerHTML = content;
                });
            } else {
                console.error("Error: " + response.status + " â€“ Failed to load contributors.");
            }
        });
    });
</script>
{% endblock %}